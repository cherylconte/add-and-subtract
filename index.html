<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Base-10 Addition/Subtraction</title>

<style>
body {
  font-family: Arial, sans-serif;
  margin:0;
  background:#f9f9f9;
  display:flex;
  flex-direction:column;
  align-items:center;
}

h2 { margin:20px; }

#controls {
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  justify-content:center;
  margin-bottom:20px;
}

input, button, select {
  font-size:16px;
  padding:5px 10px;
}

#availableBlocks {
  display:flex;
  gap:12px;
  margin-bottom:20px;
}

.block {
  cursor:pointer;
  display:flex;
  justify-content:center;
  align-items:center;
  color:white;
  font-weight:bold;
  border-radius:4px;
}

.flat { width:200px; height:200px; background:#f06; }
.rod  { width:20px;  height:200px; background:#0a0; }
.unit { width:20px;  height:20px;  background:#06f; }

#board {
  display:flex;
  width:90vw;
  border:2px solid #333;
  background:white;
  padding:20px;
  gap:20px;
}

.column {
  flex:1;
  position:relative;
  border-left:1px solid #333;
  padding-top:30px;
}

.column:first-child { border-left:none; }

.column-label {
  position:absolute;
  top:0;
  width:100%;
  text-align:center;
  font-weight:bold;
}

.row {
  display:flex;
  flex-wrap:wrap;
  gap:5px;
  margin-bottom:10px;
}

#equation {
  margin:40px 0;
  font-size:36px;
}
</style>
</head>

<body>

<h2>Base-10 Addition / Subtraction</h2>

<div id="controls">
  <input id="problemInput" value="246 + 175">
  <button id="setup">Set Up</button>
  <button id="switchRow">Switch Number</button>
</div>

<div id="availableBlocks">
  <div class="block flat">100</div>
  <div class="block rod">10</div>
  <div class="block unit">1</div>
</div>

<div id="board">
  <div class="column" id="hundreds"><div class="column-label">Hundreds</div></div>
  <div class="column" id="tens"><div class="column-label">Tens</div></div>
  <div class="column" id="ones"><div class="column-label">Ones</div></div>
</div>

<div id="equation">___ ___ ___ + ___ ___ ___ = ___ ___ ___</div>

<script>
const cols = {
  flat: document.getElementById("hundreds"),
  rod: document.getElementById("tens"),
  unit: document.getElementById("ones")
};

let currentRow = 1;

// Ensure row exists
function getRow(col) {
  let row = col.querySelector(".row" + currentRow);
  if (!row) {
    row = document.createElement("div");
    row.className = "row row" + currentRow;
    col.appendChild(row);
  }
  return row;
}

// Add block
function addBlock(type) {
  const block = document.createElement("div");
  block.className = "block " + type;
  block.dataset.type = type;

  block.addEventListener("dblclick", () => regroup(type));
  block.draggable = true;

  getRow(cols[type]).appendChild(block);
}

// ðŸ”‘ CORE FIX â€” COUNT ALL BLOCKS IN ROW
function regroup(type) {
  const rowBlocks = document.querySelectorAll(`.row${currentRow} .${type}`);

  if (type === "unit" && rowBlocks.length >= 10) {
    for (let i = 0; i < 10; i++) rowBlocks[i].remove();
    addBlock("rod");
  }

  if (type === "rod" && rowBlocks.length >= 10) {
    for (let i = 0; i < 10; i++) rowBlocks[i].remove();
    addBlock("flat");
  }

  if (type === "rod" && rowBlocks.length === 1) {
    rowBlocks[0].remove();
    for (let i = 0; i < 10; i++) addBlock("unit");
  }

  if (type === "flat" && rowBlocks.length === 1) {
    rowBlocks[0].remove();
    for (let i = 0; i < 10; i++) addBlock("rod");
  }
}

// Block palette
document.querySelectorAll("#availableBlocks .block").forEach(b => {
  b.addEventListener("click", () => {
    addBlock(b.classList.contains("flat") ? "flat" :
             b.classList.contains("rod") ? "rod" : "unit");
  });
});

// Setup
document.getElementById("setup").onclick = () => {
  Object.values(cols).forEach(c => c.innerHTML = `<div class="column-label">${c.querySelector(".column-label").innerText}</div>`);
  currentRow = 1;
  document.getElementById("equation").innerText =
    document.getElementById("problemInput").value.replace(/\d+/g, "___");
};

// Switch number (STACKING FIXED)
document.getElementById("switchRow").onclick = () => {
  currentRow = currentRow === 1 ? 2 : 1;
};
</script>

</body>
</html>

